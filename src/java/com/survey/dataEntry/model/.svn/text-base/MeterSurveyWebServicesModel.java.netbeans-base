/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package com.survey.dataEntry.model;

import com.survey.general.model.AlertsModel;
import com.survey.tableClasses.SurveyBean;
import com.survey.tableClasses.TubeWellSurveyBean;
import com.survey.util.GetDate;
import java.io.File;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;

/**
 *
 * @author Administrator
 */
public class MeterSurveyWebServicesModel {

    private Connection connection;
    private String message;
    private String msgBgColor;
    private final String COLOR_OK = "yellow";
    private final String COLOR_ERROR = "red";
    String destination_path = "";

    public Connection getConnection() {
        return connection;
    }

    public void setConnection() {
        try {
            System.out.println("hii");
            Class.forName("com.mysql.jdbc.Driver");
            connection = DriverManager.getConnection("jdbc:mysql://localhost:3306/meter_survey", "jpss_2", "jpss_1277");
        } catch (Exception e) {
            System.out.println("ReadMailModel setConnection() Error: " + e);
        }
    }

    public void closeConnection(){
        try{
            connection.close();
        }catch(SQLException ex){
            System.out.println("ERROR : in closeConnection of MeterSurveyWebServicesModel : " + ex);
        }
    }

    public int insertRecord(SurveyBean surveyBean, List list) {
        String query = "INSERT INTO survey (survey_file_no, survey_page_no, mobile_no, pole_no, pole_rev_no, survey_type, "
                + " remark, survey_date,image_name,image_date_time,longitude,lattitude,survey_pole_no,survey_id, survey_with, survey_with_name) "
                + " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";
        String query2 = "INSERT INTO switching_point_survey (switching_point_survey_id, meter_no, meter_functional,"
                + " r_phase, y_phase, b_phase, power, fuse_functional, contacter_functional, mccb_functional,"
                + " remark,created_by,fuse1,fuse2,fuse3,contacter_id,"
                + "contacter_make_id,contacter_capacity,mccb1,mccb2,mccb3,fuse_id1,fuse_id2,"
                + "fuse_id3,mccb_id1,mccb_id2,mccb_id3,no_of_phase,meter_phase,meter_reading,"
                + "auto_switch_type_id,main_switch_type_id,main_switch_rating,enclosure_type_id,reason_id,survey_rev_no, meter_name_auto, service_conn_no)"
                + " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";

        String imageQuery = "INSERT INTO general_image_details (image_name, image_destination_id, date_time, description) "
                + " VALUES(?, ?, ?, ?)";
        String query3 = "INSERT INTO tube_well_survey (tube_well_survey_id, meter_no, meter_functional,"
                + " r_phase, y_phase, b_phase, power, fuse_functional, starter_functional, mccb_functional,"
                + " remark,created_by,fuse1,fuse2,fuse3,starter_id,"
                + "starter_make_id,starter_capacity,mccb1,mccb2,mccb3,fuse_id1,fuse_id2,"
                + "fuse_id3,mccb_id1,mccb_id2,mccb_id3,no_of_phase,meter_phase,meter_reading,"
                + "auto_switch_type_id,main_switch_type_id,main_switch_rating,enclosure_type_id,reason_id,revison_no, meter_name_auto, service_conn_no)"
                + " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";

        String updateQuery = "UPDATE survey set general_image_details_id=? where image_name=? and status='Y' ";
        String meter_name_auto = surveyBean.getMeter_name_auto();
        String service_conn_no = surveyBean.getService_conn_no();
        String updateMeters = "UPDATE meters SET latitude="+surveyBean.getLatitude()+", longitude="+surveyBean.getLongitude()+" WHERE meter_name_auto='"+ meter_name_auto +"' AND final_revision='VALID' ";

        int survey_rev_no = 0;
        String image_uploaded_for = "Survey Image";
        String pole_no = surveyBean.getPole_no();
        DateFormat dateFormat = new SimpleDateFormat("dd.MMMMM.yyyy/ hh:mm:ss aaa");
        Date date = new Date();
        String current_date = dateFormat.format(date);
        int rowsAffected = 0;
        ResultSet rs = null;
//        insertSurveyCordinates(surveyBean.getLatitude(), surveyBean.getLongitude());

        try {
            String meter_query = "SELECT meter_id FROM meters WHERE meter_name_auto='"+ meter_name_auto +"' AND final_revision='VALID'";
            ResultSet rst = connection.prepareStatement(meter_query).executeQuery();
            String meter_id = "0";
            if(rst.next())
                meter_id = rst.getString(1);
            connection.setAutoCommit(false);
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            int survey_id = getSurveyId();
            //pstmt.setInt(1, survey_id + 1);
            //pstmt.setInt(1, surveyBean.getSwitching_point_detail_id());
//            if (surveyBean.getSurvey_type().equals("pole_type_survey")) {
//                pstmt.setNull(1, java.sql.Types.INTEGER);
//                pstmt.setNull(2, java.sql.Types.INTEGER);
//            } else {
//                pstmt.setInt(1, surveyBean.getSwitching_point_detail_id());
//                pstmt.setInt(2, surveyBean.getSwitching_rev_no());
//            }
            pstmt.setString(1, surveyBean.getSurvey_file_no());
            pstmt.setString(2, surveyBean.getSurvey_page_no());
            pstmt.setString(3, surveyBean.getSurvey_by());
            if (surveyBean.getSurvey_type().equals("pole_type_survey")) {
                pstmt.setString(4, surveyBean.getPole_no());
                pstmt.setInt(5, surveyBean.getPole_rev_no());
            } else {
                pstmt.setString(4, surveyBean.getPole_no());
                pstmt.setNull(5, java.sql.Types.INTEGER);
            }
            pstmt.setString(6, surveyBean.getSurvey_type());
            pstmt.setString(7, surveyBean.getRemark());

            String surveyDate = surveyBean.getSurvey_date();
            if (surveyDate != null && !(surveyDate.trim()).isEmpty()) {
                pstmt.setString(8, surveyDate.split(" ")[0]);
                //pstmt.setDate(8, convertToSqlDate(surveyBean.getSurvey_date()));
            } else {
                pstmt.setNull(8, java.sql.Types.DATE);
            }
            pstmt.setString(9, surveyBean.getImage_name());
            pstmt.setString(10, null);
            pstmt.setString(11, surveyBean.getLongitude());
            pstmt.setString(12, surveyBean.getLatitude());
            pstmt.setString(13, surveyBean.getSurvey_pole_no());
            pstmt.setInt(14, survey_id);
            pstmt.setString(15, surveyBean.getSurvey_with_contact());
            pstmt.setString(16, surveyBean.getSurvey_with_name());
            rowsAffected = pstmt.executeUpdate();
            //rowsAffected = 0;
            if (surveyBean.getSurvey_type().equals("Switching Point") || surveyBean.getSurvey_type().equals("tubewell_type_survey")) {
                if (rowsAffected > 0) {
                    rs = pstmt.getGeneratedKeys();
                    while (rs.next()) {
                        survey_id = rs.getInt(1);
                        //survey_rev_no = rs.getInt(36);
                    }
                    rowsAffected = 0;
                    pstmt.close();
                    if (surveyBean.getSurvey_type().equals("Switching Point")) {
                        pstmt = connection.prepareStatement(query2);
                    }
                    if (surveyBean.getSurvey_type().equals("tubewell_type_survey")) {
                        pstmt = connection.prepareStatement(query3);
                    }

                    pstmt.setInt(1, survey_id);
                    if (surveyBean.getMeter_status().equals("Y")) {
                        if (surveyBean.getMeter_functional().equals("Y")) {
                            pstmt.setString(2, surveyBean.getMeter_no());
                            pstmt.setString(3, surveyBean.getMeter_functional());
                            pstmt.setInt(29, surveyBean.getMeter_phase());
                            pstmt.setString(30, surveyBean.getMeter_reading());
                        } else {
                            pstmt.setString(2, surveyBean.getMeter_no());
                            pstmt.setString(3, surveyBean.getMeter_functional());
                            pstmt.setInt(29, surveyBean.getMeter_phase());
                            pstmt.setString(30, surveyBean.getMeter_reading());
                        }
                    } else {
                        pstmt.setString(2, surveyBean.getMeter_no());
                        pstmt.setString(3, surveyBean.getMeter_functional());
                        pstmt.setInt(29, surveyBean.getMeter_phase());
                        pstmt.setString(30, surveyBean.getMeter_reading());
                    }

                    if (surveyBean.getNo_of_phase() == 3) {
                        pstmt.setString(4, surveyBean.getR_phase());
                        pstmt.setString(5, surveyBean.getY_phase());
                        pstmt.setString(6, surveyBean.getB_phase());
                    } else {
                        pstmt.setNull(4, java.sql.Types.DOUBLE);
                        pstmt.setNull(5, java.sql.Types.DOUBLE);
                        pstmt.setString(6, surveyBean.getB_phase());
                    }

                    pstmt.setString(7, surveyBean.getPower());
                    pstmt.setString(8, surveyBean.getFuse_functional());
                    pstmt.setString(9, surveyBean.getContacter_functional());
                    pstmt.setString(10, surveyBean.getMccb_functional());
                    //  pstmt.setString(11, surveyBean.getTimer_functional());
                    pstmt.setString(11, surveyBean.getRemark());
                    pstmt.setString(12, "Viney Srivastva");
                    //    pstmt.setString(13, surveyBean.getMeter_status());
                    pstmt.setString(13, surveyBean.getFuse1());
                    pstmt.setString(14, surveyBean.getFuse2());
                    pstmt.setString(15, surveyBean.getFuse3());
                    if (surveyBean.getSurvey_type().equals("Switching Point")) {
                        pstmt.setString(16, surveyBean.getContacter_id());
                        pstmt.setString(17, surveyBean.getContacter_make_id());
                        pstmt.setString(18, surveyBean.getContacter_capacity());
                    } else {
                        pstmt.setInt(16, surveyBean.getStarter_id());
                        pstmt.setInt(17, surveyBean.getStarter_make_id());
                        pstmt.setString(18, surveyBean.getStarter_capacity());
                    }
                    pstmt.setString(19, surveyBean.getMccb1());
                    pstmt.setString(20, surveyBean.getMccb2());
                    pstmt.setString(21, surveyBean.getMccb3());
                    pstmt.setString(22, surveyBean.getFuse_id1());
                    pstmt.setString(23, surveyBean.getFuse_id2());
                    pstmt.setString(24, surveyBean.getFuse_id3());
                    pstmt.setString(25, surveyBean.getMccb_id1());
                    pstmt.setString(26, surveyBean.getMccb_id2());
                    pstmt.setString(27, surveyBean.getMccb_id3());
                    pstmt.setInt(28, surveyBean.getNo_of_phase());

                    pstmt.setString(31, surveyBean.getAuto_switch_type_id());
                    pstmt.setString(32, surveyBean.getMain_switch_type_id());
                    pstmt.setString(33, surveyBean.getMain_switch_rating());
                    pstmt.setString(34, surveyBean.getEnclosure_type_id());
                    if (surveyBean.getMeter_functional().equals("N")) {
                        pstmt.setString(35, getReasonId("abc"));//surveyBean.getReason_type()
                    } else {
                        pstmt.setNull(35, java.sql.Types.INTEGER);
                    }

                    pstmt.setInt(36, survey_rev_no);
                    //if(meter_name_auto == null)
                        pstmt.setString(37, meter_name_auto);
                   // else
                      //  pstmt.setNull(37, java.sql.Types.NULL);
                    
                    //if(service_conn_no == null)
                        pstmt.setString(38, service_conn_no);
                    //else
                       // pstmt.setNull(38, java.sql.Types.NULL);
                    rowsAffected = pstmt.executeUpdate();
                    if(rowsAffected > 0 &&  meter_name_auto!=null && !meter_name_auto.isEmpty()){
                        pstmt = connection.prepareStatement(updateMeters);
                        rowsAffected = pstmt.executeUpdate();                        
                        updateStatusData(meter_id);
                    }
                    if(rowsAffected > 0)
                        rowsAffected = updateCalculatedLoad(surveyBean.getPower(), meter_name_auto);
                    if (rowsAffected > 0) {
                        if (surveyBean.getImage_name() != null && !surveyBean.getImage_name().isEmpty()) {
                            try {
                                pstmt = connection.prepareStatement(imageQuery);
                                pstmt.setString(1, surveyBean.getImage_name());
                                pstmt.setInt(2, getimage_destination_id(image_uploaded_for));
                                pstmt.setString(3, current_date);
                                pstmt.setString(4, "this image is for survey");

                                rowsAffected = pstmt.executeUpdate();
                                pstmt.close();
                            } catch (Exception e) {
                                System.out.println("Error:keypersonModel--insertRecord-- " + e);
                            }
                            if (rowsAffected > 0) {
                                try {
                                    //if (writeImage(surveyBean.getImage_name(), list) > 0) {
                                        pstmt = connection.prepareStatement(updateQuery);
                                        pstmt.setInt(1, getgeneral_image_details_id(surveyBean.getImage_name()));
                                        pstmt.setString(2, surveyBean.getImage_name());
                                        pstmt.executeUpdate();
                                    //}
                                } catch (Exception e) {
                                    System.out.println("Exception :" + e);
                                    rowsAffected = 1;
                                }
                            }
                        }
                        // rowsAffected = writeImage(key, itr, destination);
                        if (rowsAffected > 0) {
                            message = "Record saved successfully.";
                            msgBgColor = COLOR_OK;
                            connection.commit();
                            if (rowsAffected > 0) {
                                AlertsModel alertModel = new AlertsModel();
                                alertModel.setConnection(connection);
                                rowsAffected = alertModel.insertAlertSheetData(survey_id, pole_no);
                            }
                            rowsAffected = 1;
                        }

                    } else {

                        connection.rollback();
                    }
                } else {
                    //query1 execution
                    connection.rollback();
                }
            }
        } catch (Exception e) {
            rowsAffected = -1;
            System.out.println("Error while inserting record...." + e);
            try {
                connection.rollback();
            } catch (SQLException sql) {
                System.out.println("SQLException occured during Updation is: " + sql);
            }

        } finally {
            try {
                if (surveyBean.getSurvey_type().equals("pole_type_survey")) {
                    if (rowsAffected > 0) {
                        connection.commit();
                    }
                }
                connection.setAutoCommit(true);
            } catch (SQLException ex) {
                System.out.println("SQLException occured while setting autoCommit = true duing new flex updation :" + ex);
                // Logger.getLogger(CreateEstimateModel.class.getName()).log(Level.SEVERE, null, ex);
            }
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;
    }

    public int updateCalculatedLoad(String power, String meter_name_auto){
        int rowsAffected = 0;
        int revision = getMeterRevision(meter_name_auto);
        String query = "INSERT INTO meters (meter_id, revision, meter_name, security_deposit, sd_receipt_no, date, initial_reading, city_id, meter_service_number, poll_no, active, organisation_id, org_office_id, switching_point_id, feeder_id, sanctioned_load_kw, reason, final_revision, phase, accessed_load, effective_date, calculated_load, description, tariff_code, msn_first_part, msn_sec_part, msn_third_part, msn_fourth_part, ivrs_no, file_no, calculated_security_deposit, meter_name_auto, sanct_load_unit_id, latitude, longitude, ward_no, bill_sanction_load, premises_tariff_map_id, premises_tariff_map_rev, address_asper_Bill, general_img_details_id)"
                + " SELECT  meter_id, revision+1, meter_name, security_deposit, sd_receipt_no, date, initial_reading, city_id, meter_service_number, poll_no, active, organisation_id, org_office_id, switching_point_id, feeder_id, sanctioned_load_kw, reason, final_revision, phase, accessed_load, effective_date, 22, description, tariff_code, msn_first_part, msn_sec_part, msn_third_part, msn_fourth_part, ivrs_no, file_no, calculated_security_deposit, meter_name_auto, sanct_load_unit_id, latitude, longitude, ward_no, bill_sanction_load, premises_tariff_map_id, premises_tariff_map_rev, address_asper_Bill, general_img_details_id "
                + " FROM meters WHERE meter_name_auto = '"+ meter_name_auto +"' AND final_revision='VALID'";
        String updateQuery = "UPDATE meters SET final_revision='EXPIRED' WHERE meter_name_auto = '"+ meter_name_auto +"' AND revision=" + revision;
        try{
            rowsAffected = connection.prepareStatement(query).executeUpdate();
            if(rowsAffected > 0)
                rowsAffected = connection.prepareStatement(updateQuery).executeUpdate();
        }catch(Exception ex){
            System.out.println("ERROR : in updateCalculatedLoad in MeterSurveywebServiceModel : " + ex);
        }
        return rowsAffected;
    }

    public int getMeterRevision(String meter_name_auto){
        int revision = 0;
        String query = "SELECT revision FROM meters WHERE meter_name_auto = '"+ meter_name_auto +"' AND final_revision='VALID'";
        try{
            ResultSet rs = connection.prepareStatement(query).executeQuery();
            if(rs.next())
                revision = rs.getInt(1);
        }catch(Exception ex){
            System.out.println("ERROR : in getMeterRevision in MeterSurveywebServiceModel : " + ex);
        }
        return revision;
    }

    public java.sql.Date convertToSqlDate(String date) throws ParseException {
        java.sql.Date finalDate = null;
        String strD = date;
        String[] str1 = strD.split("-");
        strD = str1[1] + "/" + str1[0] + "/" + str1[2]; // Format: mm/dd/yy
        finalDate = new java.sql.Date(DateFormat.getDateInstance(DateFormat.SHORT, new Locale("en", "US")).parse(strD).getTime());
        return finalDate;
    }

    public boolean validationCheck(int id, int rev_no, String survey_type) {
        int rowCount = 0;
        String id_field_name = "";
        String rev_field_name = "";
        if (survey_type.equals("switching_type_survey")) {
            id_field_name = "switching_point_detail_id = ";
            rev_field_name = "switching_rev_no = ";
        } else {
            id_field_name = "pole_id = ";
            rev_field_name = "pole_rev_no = ";
        }
        String query = "select count(*) from survey where " + id_field_name + id + " AND " + rev_field_name + rev_no + " AND status = 'Y'";
        try {
            ResultSet rs = connection.prepareStatement(query).executeQuery();
            if (rs.next()) {
                rowCount = rs.getInt("count(*)");
            }
        } catch (Exception e) {
            System.out.println("Exception inside validation check " + e);
        }
        if (rowCount > 0) {
            if (survey_type.equals("switching_type_survey")) {
                message = "Survey of this Switching Point has Already been done, Kindly Revise it..";
            } else {
                message = "Survey of this Pole has Already been done, Kindly De-Activate the former one";
            }
            msgBgColor = COLOR_ERROR;
        }
        return rowCount > 0 ? false : true;
    }

    public String getSwitchingPoint_id(String pole_no) {
        String switching_id_rev = "";
//        String query = "select spd.switching_point_detail_id, spd.switching_rev_no from switching_point_detail spd "
//                + " LEFT JOIN pole p ON p.switching_point_detail_id = spd.switching_point_detail_id AND spd.switching_rev_no = p.switching_rev_no "
//                + " WHERE spd.active = 'Y' AND p.active = 'Y' AND p.isSwitchingPoint = 'Yes' AND p.pole_no = ? ";
        String query = "select meter_id from meters where poll_no='" + pole_no + "' and final_revision='VALID'";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            //  ps.setString(1, pole_no);
            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                switching_id_rev = rset.getString("meter_id");//String.valueOf(rset.getInt("switching_point_detail_id")) + "_" + String.valueOf(rset.getInt("switching_rev_no"));
            }
        } catch (Exception e) {
            System.out.println("Exception in SwitchingPoint_id() in surveyModel" + e);
        }
        return switching_id_rev;

    }

    public String getPoleId(String Pole_no) {
        String pole_id_rev = "";
        String query = " select pole_id , pole_rev_no from pole where active = 'Y' AND isSwitchingPoint = 'No' AND pole_no = ?";
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, Pole_no);
            ResultSet rset = pstmt.executeQuery();
            rset.next();    // move cursor from BOR to valid record.
            pole_id_rev = String.valueOf(rset.getInt("pole_id")) + "_" + String.valueOf(rset.getInt("pole_rev_no"));
        } catch (Exception e) {
            System.out.println("SurveyModel getPoleId() Error: " + e);
        }
        return pole_id_rev;
    }

    public int insertFuseRecord(String fuse_type) {

        String query = "INSERT INTO fuse (fuse_type, remark) VALUES (?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, fuse_type);
            pstmt.setString(2, "Done");
            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }


    public int insertMccbRecord(String mccb_type) {

        String query = "INSERT INTO mccb (mccb_type, remark) VALUES (?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, mccb_type);
            pstmt.setString(2, "Done");
            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }

    public int insertAutoSwitchRecord(SurveyBean surveyBean) {

        String query = "INSERT INTO switch_type(switch_type,switch_id, remark) VALUES (?,?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            // if (!surveyBean.getAuto_switch_type().isEmpty() || surveyBean.getAuto_switch_type() != null) {
            pstmt.setString(1, surveyBean.getAuto_switch_type());
            pstmt.setInt(2, 1);
            //}
            pstmt.setString(3, "Done");
            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }
    public int insertMainSwitchRecord(SurveyBean surveyBean) {

        String query = "INSERT INTO switch_type(switch_type,switch_id, remark) VALUES (?,?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            // if (!surveyBean.getAuto_switch_type().isEmpty() || surveyBean.getAuto_switch_type() != null) {
            pstmt.setString(1, surveyBean.getMain_switch_type());
            pstmt.setInt(2, 1);
            // } else if (!surveyBean.getMain_switch_type().isEmpty() || surveyBean.getMain_switch_type() != null) {
            //   pstmt.setString(1, surveyBean.getMain_switch_type());
            //   pstmt.setInt(2, 2);
            // }
            pstmt.setString(3, "Done");
            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }

    public int insertContacterRecord(SurveyBean surveyBean) {

        String query = "INSERT INTO contacter (contacter_type, remark) VALUES (?,?) ";
        String query1 = "INSERT INTO starter (starter_type, remark) VALUES (?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = null;
            if (surveyBean.getSurvey_type().equals("Switching Point")) {
                pstmt = connection.prepareStatement(query);
                pstmt.setString(1, surveyBean.getContacter_type());
                pstmt.setString(2, "Done");
            } else {
                pstmt = connection.prepareStatement(query1);
                pstmt.setString(1, surveyBean.getStarter_type());
                pstmt.setString(2, "Done");
            }


            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }

    public int insertContacterMakeRecord(SurveyBean surveyBean) {

        String query = "INSERT INTO contacter_make (contacter_make, remark) VALUES (?,?) ";
        String query1 = "INSERT INTO starter_make (starter_make, remark) VALUES (?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = null;
            if (surveyBean.getSurvey_type().equals("Switching Point")) {
                pstmt = connection.prepareStatement(query);
                pstmt.setString(1, surveyBean.getContacter_make());
                pstmt.setString(2, "Done");
            } else {
                pstmt = connection.prepareStatement(query1);
                pstmt.setString(1, surveyBean.getStarter_make());
                pstmt.setString(2, "Done");
            }


            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }

    public int insertEnclosureRecord(SurveyBean surveyBean) {

        String query = "INSERT INTO enclosure_type (enclosure_type, remark) VALUES (?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, surveyBean.getEnclosure_type());
            pstmt.setString(2, "Done");
            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }

    public int insertReasonRecord(SurveyBean surveyBean) {

        String query = "INSERT INTO reason_type (reason_type, remark) VALUES (?,?) ";
        int rowsAffected = 0;
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, surveyBean.getReason_type());
            pstmt.setString(2, "Done");
            rowsAffected = pstmt.executeUpdate();
        } catch (Exception e) {
            System.out.println("Error while inserting record...." + e);
        }
        if (rowsAffected > 0) {
            message = "Record saved successfully.";
            msgBgColor = COLOR_OK;
        } else {
            message = "Cannot save the record, some error.";
            msgBgColor = COLOR_ERROR;
        }
        return rowsAffected;

    }

    public int writeImage(String imageName, List<File> file) {
        // getimage_destination_id();
        System.out.println("Start to write payment images in Repository");
        try {
            File srcfile = null;
            //      String dayOfMonthFolder = createAppropriateDirectories(destination_path);
            //File folder = new File(dayOfMonthFolder);
            boolean isuploaded = false;
            Iterator<File> fileItr = file.iterator();
            //  int number_of_file = folder.list().length;
            while (fileItr.hasNext()) {
//                Object image = fileItr.next();
//                tempSource = image.toString();
                //  number_of_file++;
                srcfile = fileItr.next();
                // String ext = srcfile.getName().replace(".", "%#");
                //ext = ext.split("%#")[1];
                String image = srcfile.toString();
                int index = image.indexOf('.');
                System.out.println(index);
                String ext = image.substring(index, image.length());
                // String image_name = imageName + "_" + number_of_file + ext;
                // System.out.println("" + image_name);
                // String forlder_path = dayOfMonthFolder + "/" + imageName + "_" + number_of_file;
                File desfile = new File(destination_path + "/" + imageName);
                isuploaded = srcfile.renameTo(desfile);

                if (isuploaded) {
                    message = "Image Uploaded Successfully.";
                    msgBgColor = COLOR_OK;

                }

            }
            File deleteFile = new File(getRepositoryPath("Temp"));
            deleteDirectory(deleteFile);
        } catch (Exception ex) {
            System.out.println("File write error" + ex);
            message = "Cannot upload the image, some error.";
            msgBgColor = COLOR_ERROR;
            PreparedStatement pstmt;
            int rowsAffected = 0, id;
            String query, query1;
            query = "UPDATE survey"
                    + "SET general_image_details_id = NULL  "
                    + " where image_name = ? ";
            try {
                pstmt = (PreparedStatement) connection.prepareStatement(query);
                pstmt.setString(1, imageName);
                rowsAffected = pstmt.executeUpdate();
            } catch (Exception e) {
                System.out.println("Error: GeneralImageDetailsModel-record cannot updated when image is not uploaded successfully-" + e);
            }
            query1 = "DELETE from general_image_details WHERE general_image_details_id= ? ";
            try {
                pstmt = (PreparedStatement) connection.prepareStatement(query1);
                pstmt.setInt(1, getgeneral_image_details_id(imageName));
                rowsAffected = pstmt.executeUpdate();
            } catch (Exception e) {
                System.out.println("Error: ReadMailModel-record cannot deleted when image is not uploaded successfully-" + e);
            }
        }
        return message.equals("Image Uploaded Successfully.") ? 1 : 0;
    }

    public boolean deleteDirectory(File dir) {
        if (dir.isDirectory()) {
            File[] children = dir.listFiles();
            for (int i = 0; i < children.length; i++) {
                boolean success = deleteDirectory(children[i]);
                if (!success) {
                    return false;
                }
            }
        }
        System.out.println("removing file or directory : " + dir.getName());
        return dir.delete();
    }

    public int getgeneral_image_details_id(String image_name) {
        String query;
        int key_person_id = 0;
        query = "select general_image_details_id from general_image_details where image_name='" + image_name + "' and active='Y' ";
        try {
            PreparedStatement pstmt = connection.prepareStatement(query);

            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {

                key_person_id = rset.getInt("general_image_details_id");

            }

        } catch (Exception ex) {
            System.out.println("Error:  getgeneral_image_details_id-" + ex);
        }
        return key_person_id;
    }

    public int getSurveyId() {
        String query;
        int survey_id = 0;
        query = "select MAX(survey_id) as id from survey where status='Y'  ";
        try {
            PreparedStatement pstmt = connection.prepareStatement(query);

            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {

                survey_id = rset.getInt("id");
                survey_id = survey_id + 1;
            }

        } catch (Exception ex) {
            System.out.println("Error: getSurveyId() " + ex);
        }
        return survey_id;
    }

    public int getimage_destination_id(String image_uploaded_for) {
        String query;
        int image_destination_id = 0;
        query = " SELECT image_destination_id, destination_path from image_destination AS id , image_uploaded_for As i "
                + " WHERE id.image_uploaded_for_id=i.image_uploaded_for_id AND i.image_uploaded_for_name= ? ";
        try {
            PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, image_uploaded_for);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                image_destination_id = rset.getInt("image_destination_id");
            }

        } catch (Exception ex) {
            System.out.println("Error: getimage_destination_id-" + ex);
        }
        return image_destination_id;
    }

    public String getRepositoryPath(String image_uploaded_for) {
        String query;

        query = " SELECT destination_path from image_destination AS id , image_uploaded_for As i "
                + " WHERE id.image_uploaded_for_id=i.image_uploaded_for_id AND i.image_uploaded_for_name= ? ";
        try {
            PreparedStatement pstmt = connection.prepareStatement(query);
            pstmt.setString(1, image_uploaded_for);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                this.destination_path = rset.getString("destination_path");
            }

        } catch (Exception ex) {
            System.out.println("Error: UploadBillImageModel-getimage_destination_id-" + ex);
        }
        return this.destination_path;
    }

    public String getFuseId(String fuse_type) {
        String fuse_id = "";
        String query = "select fuse_id from fuse where fuse_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, fuse_type);
            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                fuse_id = rset.getString("fuse_id");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return fuse_id;
    }

    public String getContracterId(String contracter_type) {
        String contracter_id = "";
        String query = "select contacter_id from contacter where contacter_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, contracter_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                contracter_id = rset.getString("contacter_id");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return contracter_id;
    }

    public int getStarterId(String contracter_type) {
        int contracter_id = 0;
        String query = "select starter_id from starter where starter_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, contracter_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                contracter_id = rset.getInt("starter_id");
            }
        } catch (Exception e) {
            System.out.println("Exception in getStarterId() in surveyModel" + e);
        }
        return contracter_id;
    }

    public String getMccbId(String mccb_type) {
        String mccb_id = "";
        String query = "select mccb_id from mccb where mccb_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, mccb_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                mccb_id = rset.getString("mccb_id");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return mccb_id;
    }

    public int getTimerId(String timer_type) {
        int timer_id = 0;
        String query = "select timer_id from timer where timer_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, timer_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                timer_id = rset.getInt("timer_id");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return timer_id;
    }

    public String getFuseTYpe(int fuse_id) {
        String fuse_type = "";
        String query = "select fuse_type from fuse where fuse_id='" + fuse_id + "'";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, fuse_type);
            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                fuse_type = rset.getString("fuse_type");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return fuse_type;
    }

    public String getContracterType(int contracter_id) {
        String contracter_type = "";
        String query = "select contacter_type from contacter where contacter_id'" + contracter_id + "'";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            // ps.setString(1, contracter_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                contracter_type = rset.getString("contacter_type");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return contracter_type;
    }

    public String getMccbType(int mccb_id) {
        String mccb_type = "";
        String query = "select mccb_type from mccb where mccb_id='" + mccb_id + "'";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            //  ps.setString(1, mccb_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                mccb_type = rset.getString("mccb_type");
            }
        } catch (Exception e) {
            System.out.println("Exception in getMccbType() in surveyModel" + e);
        }
        return mccb_type;
    }

    public String getTimerId(int timer_id) {
        String timer_type = "";
        String query = "select timer_id from timer where timer_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            //  ps.setString(1, timer_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                timer_type = rset.getString("timer_type");
            }
        } catch (Exception e) {
            System.out.println("Exception in getPole_No() in surveyModel" + e);
        }
        return timer_type;
    }

    public String getReasonId(String reason_type) {
        String reason_id = "";
        String query = "select reason_id from reason_type where reason_type=?";
        try {
            PreparedStatement ps = connection.prepareStatement(query);
            ps.setString(1, reason_type);

            ResultSet rset = ps.executeQuery();
            if (rset.next()) {
                reason_id = rset.getString("reason_id");
            }
        } catch (Exception e) {
            System.out.println("Exception in getReasonId() in surveyModel" + e);
        }
        return reason_id;
    }

    public String getSwitchId(String switch_type) {

        String switch_type_id = "";
        String query = " SELECT st.switch_type_id FROM switch_type as st,switch as s WHERE  "
                + "s.switch_id=st.switch_id and st.switch_type='" + switch_type + "' group by switch_type_id";
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                switch_type_id = rset.getString("switch_type_id");
            } else {
                switch_type_id = "";
            }
        } catch (Exception e) {
            System.out.println("SurveyModel getSwitchId() Error: " + e);
        }
        return switch_type_id;
    }

    public String getEnclosureTypeId(String enclosure_type) {

        String enclosure_type_id = "";
        String query = " SELECT enclosure_type_id FROM enclosure_type WHERE  enclosure_type='" + enclosure_type + "'"
                + "group by enclosure_type_id";
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                enclosure_type_id = rset.getString("enclosure_type_id");
            } else {
                enclosure_type_id = "";
            }
        } catch (Exception e) {
            System.out.println("SurveyModel getEnclosureTypeId() Error: " + e);
        }
        return enclosure_type_id;
    }

    public int getStarterMakeId(String starter_make) {

        int starter_make_id = 0;
        String query = " SELECT starter_make_id FROM starter_make WHERE starter_make='" + starter_make + "'  "
                + "group by starter_make_id";
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                starter_make_id = rset.getInt("starter_make_id");
            } else {
                starter_make_id = 0;
            }
        } catch (Exception e) {
            System.out.println("SurveyModel getStarterMakeId() Error: " + e);
        }
        return starter_make_id;
    }

    public String getContacterMakeId(String make_type) {

        String make_id = "";
        String query = " SELECT contacter_make_id FROM contacter_make WHERE contacter_make='" + make_type + "'  "
                + "group by contacter_make_id";
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                make_id = rset.getString("contacter_make_id");
            } else {
                make_id = "";
            }
        } catch (Exception e) {
            System.out.println("SurveyModel getContacterMakeId() Error: " + e);
        }
        return make_id;
    }

    public int getContacterStarterType() {

        int make_id = 0;
        String query = "SELECT contacter_type AS key1, 'c' AS value1 FROM contacter "
                + "UNION SELECT starter_type AS key1, 's' AS value1 FROM starter ";
        try {
            java.sql.PreparedStatement pstmt = connection.prepareStatement(query);
            ResultSet rset = pstmt.executeQuery();
            while (rset.next()) {
                //  if(rset.getString("value1").equals("c")){
                JSONObject obj = new JSONObject();
                JSONArray contacter = new JSONArray();
                contacter.add(rset.getString("key1"));
                obj.put(rset.getString("value1"), contacter);
                // }
            }
        } catch (Exception e) {
            System.out.println("SurveyModel getEnclosureTypeId() Error: " + e);
        }
        return make_id;
    }

    public JSONArray showData(String imei) {

        JSONArray rowData = new JSONArray();
        GetDate getDate = new GetDate();
        String year = String.valueOf(getDate.getCurrentYear());
        String previous_month = getDate.getPreviousMonth(getDate.getCurrentMonth(), year);
        List<String> list = new ArrayList<String>();
        String meter_id = null;
        String meter_query = "select meter_id from meters_status";
        if(imei != null && !imei.isEmpty())
            meter_query = "select meter_id from meters_status where status='Yes'";
        String query = "select m.longitude,m.latitude,m.ivrs_no, if(mb.current_reading is null,0.0,mb.current_reading) as current_reading,if(m.switching_point_id is not null,"
                + "concat_ws(sp.address1,sp.address2,sp.address3),concat_ws(of.address_line1,of.address_line2,of.address_line3) ) as address,"
                + "tp.type_of_premsis, m.meter_id, m.meter_service_number , m.poll_no , m.meter_name, m.switching_point_id ,m.initial_reading,"
                + " m.phase,o.organisation_name , tp.type_of_premsis,tp.premises_individual_detail, c.city_name, m.meter_name_auto,m.meter_service_number,"
                + "m.latitude,m.longitude FROM meters as m LEFT JOIN mpeb_meter_bill as  mb ON mb.meter_id = m.meter_id AND mb.final_revision = 'VALID' "
                + "and mb.bill_month='Nov-2015' left join switching_point as sp ON m.switching_point_id=sp.switching_point_id left join"
                + " org_office as of ON m.org_office_id=of.org_office_id,city c ,organisation_name o, type_of_premises tp , feeder f, zone z,division d, "
                + "tarrif_gen_details t, premises_tariff_map ptm, company cy, circle ci  ,meters_status as ms "
                + " WHERE ms.meter_id=m.meter_id  "
                + " and IF('"+ imei +"'='', ms.status LIKE '%%', ms.status = 'Yes')"
                + " and IF(0=0 , m.org_office_id like '%%' OR m.org_office_id is null,"
                + " m.org_office_id = 0 ) AND   m.city_id = c.city_id  and m.organisation_id= o.organisation_id  and m.final_revision='VALID'"
                + " AND cy.company_id = ci.company_id and ci.circle_id = d.circle_id  and  f.zone_id = z.zone_id and  z.division_id = d.division_id"
                + "  and m.active='Y'  and m.feeder_id = f.feeder_id and m.premises_tariff_map_id = ptm.premises_tariff_map_id AND ptm.active='Y'"
                + " and d.active = 'Y' AND ptm.type_of_premises_id = tp.type_of_premises_id and   ptm.tarrif_gen_details_id = t.tarrif_gen_details_id"
                + " and t.active = 'Y'  AND  if(0=0 , cy.company_id like '%%' , cy.company_id=0)"
                + "  AND IF ('ALL'='ALL' ,tp.type_of_premsis LIKE '%%' ,tp.type_of_premsis = 'ALL')"
                + " AND m.premises_tariff_map_id not IN (10,12,13) ";            //ID of Building type connection
//        String query = "SELECT pole_no_s as poll_no,meter_no_s as meter_name,p.type_of_premsis,meter_id,longitude,"
//                + "lattitude as latitude,ph as phase,measured_load as current_reading,ivrs_no as meter_service_number "
//                + "FROM tube_well_detail as t ,type_of_premises as p "
//                + " where p.type_of_premises_id=t.type_of_premises_id and  active='Y' and meter_id is not null";

        try {
            java.sql.PreparedStatement pstmt = null;
            ResultSet rset = null;
//            pstmt = connection.prepareStatement(meter_query);
//            rset = pstmt.executeQuery();
//            while (rset.next()) {
//                meter_id = rset.getString("meter_id");
//                list.add(meter_id);
//            }
//
//            pstmt.close();
//            Iterator<String> itr = list.iterator();
//            while (itr.hasNext()) {
//                String listString = itr.next();
                pstmt = connection.prepareStatement(query);
                //pstmt.setString(1, listString);
                rset = pstmt.executeQuery();

                while (rset.next()) {

                    JSONObject obj = new JSONObject();
                    //    int numColumns = rsmd.getColumnCount();
                    //   for (int i = 1; i < numColumns + 1; i++) {

                    //   String column_name = rsmd.getColumnLabel(i);
                    obj.put("pole_type", rset.getString("type_of_premsis"));
                    obj.put("meter_id", rset.getString("meter_id"));
                    obj.put("poll_no", rset.getString("poll_no"));
                    obj.put("meter_name", rset.getString("meter_name"));
                    obj.put("phase", rset.getString("phase"));
                    obj.put("initial_reading", rset.getString("current_reading"));
                    obj.put("meter_address", rset.getString("address"));
                    obj.put("lattitude", rset.getString("latitude"));
                    obj.put("longitude", rset.getString("longitude"));
                    obj.put("service_number", rset.getString("ivrs_no"));
                    obj.put("meter_name_auto", rset.getString("meter_name_auto"));



//                  obj.put("pole_type", rset.getString("type_of_premsis"));
//                obj.put("meter_id", rset.getString("meter_id"));
//                obj.put("poll_no", rset.getString("poll_no"));
//                obj.put("meter_name", rset.getString("meter_name"));
//                obj.put("phase", rset.getString("phase"));
//                obj.put("initial_reading", rset.getString("current_reading"));
//                //obj.put("meter_address", rset.getString("address"));
//                obj.put("meter_address", "abc");
//                obj.put("service_number", rset.getString("meter_service_number"));
//                obj.put("lattitude", rset.getString("latitude"));
//                obj.put("longitude", rset.getString("longitude"));

                    //obj.put("Company List", rowData);
//                    if(updateStatusData(meter_id)>0)
//                    {
                    rowData.add(obj);
//                    }

                    //}


                    // }

                }

          //  }
        } catch (Exception e) {
            System.out.println("SurveyModel showData() Error: " + e);
        }
        return rowData;
    }    
    
    public int updateStatusData(String meter_id){
        int row_affected=0;
        String query="UPDATE meters_status set status='Yes' where meter_id='"+meter_id+"' ";
        try{
            PreparedStatement pstmt=connection.prepareStatement(query);
            row_affected=pstmt.executeUpdate();

        }
        catch(Exception e){}


        return row_affected;
    }

    public int insertSurveyCordinates(String lat, String lng, String imei, String type, String mobile_no){
        int rowAffected = 0;
        String query = "INSERT INTO survey_cordinates (latitude, longitude, imei_no, contact_no) VALUES("+ lat +","+ lng +",'"+ imei +"', '"+ mobile_no +"')";
        try{
            rowAffected = connection.prepareStatement(query).executeUpdate();
        }catch(Exception ex){
            System.out.println("ERROR: in insertSurveyCordinates in MeterSurveyWebServicesModel : " + ex);
        }
        return rowAffected;
    }
}
